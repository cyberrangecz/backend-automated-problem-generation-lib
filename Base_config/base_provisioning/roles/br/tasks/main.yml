---
# Configuration for the border router

- name: Enable IP forwarding
  copy:
    dest: "/etc/sysctl.conf"
    content: "net.ipv4.ip_forward=1"

- name: Restarting procps service
  command: /etc/init.d/procps restart

- name: Add server alias
  lineinfile:
    path: /etc/hosts
    line: 10.10.20.5 server

- name: Add home alias
  lineinfile:
    path: /etc/hosts
    line: 10.10.30.5 home

- name: Add router alias
  lineinfile:
    path: /etc/hosts
    line: 10.10.20.1 router

- name: Add router alias
  lineinfile:
    path: /etc/hosts
    line: 10.10.30.1 router

- name: Add router alias
  lineinfile:
    path: /etc/hosts
    line: 172.18.0.5 router

- name: Add br alias
  lineinfile:
    path: /etc/hosts
    line: 172.18.0.1 br


 
- name: Add routing to network 10.10.20.0/24 
  command: route add -net 10.10.20.0/24 gw 172.18.0.5 eth1
 
- name: Add routing to network 10.10.30.0/24 
  command: route add -net 10.10.30.0/24 gw 172.18.0.5 eth1

- name: Add postrouting
  # ssh connection fails without async after execution of iptables commands
  shell: "sleep 2 && sudo iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 172.18.10.1"
  async: 1
  poll: 0

...