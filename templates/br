---
# Configuration for the border router

- name: Enable IP forwarding
  copy:
    dest: "/etc/sysctl.conf"
    content: "net.ipv4.ip_forward=1"

- name: Restarting procps service
  command: /etc/init.d/procps restart

{% for host in hosts %}
- name: Add {{ host.host_name }} alias
  lineinfile:
    path: /etc/hosts
    line: {{ host.host_ip }} {{ host.host_name }}

{% endfor %}
{% for router in routers %}
- name: Add {{ router.router_name }} alias
  lineinfile:
    path: /etc/hosts
    line: {{ router.router_ip }} {{ router.router_name }}

{% endfor %}

{% for target_cidr, router_ip in br_routes.items() %} 
- name: Add routing to network {{ target_cidr }} 
  command: route add -net {{ target_cidr }} gw {{ router_ip }} eth1
{% endfor %}

- name: Add postrouting
  # ssh connection fails without async after execution of iptables commands
  shell: "sleep 2 && sudo iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to-source {{ border_router_public_ip }}"
  async: 1
  poll: 0

{# name: Save postrouting rule #}
{# command: su -c 'iptables-save > /etc/iptables.rules' #}
...
